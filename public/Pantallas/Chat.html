<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ByteTalk - Conversación</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Exo+2:wght@800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/Chats.css" />
<link rel="stylesheet" href="/Sidebar.css" />
<style>

    .chat-container {

      max-width: 800px;

      margin: 2rem auto; 

      padding: 0 1rem;

    }
</style>
</head>
<body>
 
  <!-- Sidebar -->
<nav class="sidebar">
<h2 class="app-title">ByteTalk</h2>
<ul>
<li><a href="/Pantallas/Chats.html">Volver a chats</a></li>
<li><a href="/Pantallas/Perfil.html">Perfil</a></li>
<li><a href="/Pantallas/Admin.html">Tareas</a></li>
<li><a href="/LogIn.html">Cerrar sesión</a></li>
</ul>
<p id="username" class="text-light mt-3 ms-3"></p>
</nav>
 
  <!-- Contenedor del chat centrado -->
<div class="chat-container">
<div class="card">
<div class="card-header d-flex align-items-center justify-content-between">
  <div id="chat-header" class="d-flex align-items-center"></div>
  <div>
    <button id="startVideoCall" class="btn btn-outline-primary" style="margin-right:10px;">📹 Videollamada</button>
    <button id="toggleEncryption" class="btn btn-outline-secondary">🔒 Cifrado: Desactivado</button>
  </div>
</div>
<div class="card-body" id="mensajes" style="height: 400px; overflow-y: auto;"></div>
<div class="card-footer">
<form id="formularioMensaje" class="d-flex gap-2">
<input type="text" id="mensaje" class="form-control" placeholder="Escribe tu mensaje..." required />
<button type="submit" class="btn btn-primary">Enviar</button>
</form>
  <!-- Input para archivos -->
  <input type="file" id="file-input" class="form-control mt-2">
  <button onclick="enviarArchivo()" class="btn btn-secondary mt-2">📂 Enviar Archivo</button>
</div>
</div>
</div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>
<script>
    let usuarioActual = null;
    const socket = io();

    // Obtener usuario actual
    fetch('/api/usuario-actual')
      .then(res => res.json())
      .then(data => {
          if (!data || !data._id) {
          console.warn("⚠️ Usuario no autenticado");
          window.location.href = "LogIn.html";
          return;
        }
        usuarioActual = data;
        document.getElementById('username').textContent = data.nombreUsuario;
        socket.emit('usuarioConectado', data.nombreUsuario);

        iniciarChat();
      })
      .catch(err => {
        console.error("Error al obtener usuario:", err);
        window.location.href = '/LogIn.html';
      });

    function iniciarChat() {
      const urlParams = new URLSearchParams(window.location.search);
      const chatId = urlParams.get('id');
      const tipo = urlParams.get('tipo');
      console.log("🔍 Parámetros de URL:", Object.fromEntries(urlParams));
      socket.emit('joinRoom', chatId);
      loadChatInfo(chatId, tipo);
      loadMensajes(chatId);

      setTimeout(() => {
        console.log("Usuario después de 3 segundos:", usuarioActual);
        document.getElementById("username").textContent = usuarioActual.nombreUsuario || "Desconocido";
      }, 3000);
    }

    function loadChatInfo(chatId, tipo) {
      fetch(`/api/chat-info?id=${chatId}&tipo=${tipo}`)
        .then(res => res.json())
        .then(data => {
          const chatHeader = document.getElementById('chat-header');
          if (tipo === 'individual') {
            chatHeader.innerHTML = `
<img src="${data.avatar || '/default-avatar.png'}" alt="${data.nombre}" style="width:40px;height:40px;border-radius:50%;margin-right:10px;">
<h5 class="mb-0">${data.nombre}</h5>
            `;
          } else {
            chatHeader.innerHTML = `<h5 class="mb-0">${data.nombre}</h5>`;
          }
        })
        .catch(err => console.error('Error al cargar info del chat:', err));
    }

  function loadMensajes(chatId) {
  fetch(`/api/mensajes?chatId=${chatId}`)
    .then(res => res.json())
    .then(mensajes => {
      console.log("📩 Mensajes recibidos:", mensajes);
      const mensajesDiv = document.getElementById('mensajes');
      mensajesDiv.innerHTML = '';

      mensajes.forEach(m => {
        const div = document.createElement('div');
        div.className = 'mb-2';
        div.innerHTML = `<strong>${m.sender.nombreUsuario}:</strong> ${m.texto || ""}`;

        //Manejo de archivos adjuntos
        if (m.archivoUrl) {
          const extension = m.archivoUrl.split('.').pop().toLowerCase();
          
          if (["jpg", "jpeg", "png", "gif", "webp"].includes(extension)) {
            const imgElemento = document.createElement('img');
            imgElemento.src = m.archivoUrl;
            imgElemento.alt = "Imagen adjunta";
            imgElemento.style = "max-width:200px; border-radius:5px; margin-top:5px;";
            div.appendChild(imgElemento);
          } else {
            div.innerHTML += `<br><a href="${m.archivoUrl}" target="_blank">📂 Ver archivo adjunto</a>`;
          }
        }

        mensajesDiv.appendChild(div);
      });

      mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
    })
    .catch(err => console.error('Error al cargar mensajes:', err));
}

    // 🔒 Cifrado opcional
    let cifradoActivo = false;

    document.getElementById('toggleEncryption').addEventListener('click', () => {
      cifradoActivo = !cifradoActivo;
      document.getElementById('toggleEncryption').textContent = cifradoActivo ? "🔓 Cifrado: Activado" : "🔒 Cifrado: Desactivado";
    });

    // Envío de mensajes con cifrado opcional
    document.getElementById('formularioMensaje').addEventListener('submit', async (e) => {
  e.preventDefault();
  const texto = document.getElementById('mensaje').value.trim();
  if (!texto) return;

  const urlParams = new URLSearchParams(window.location.search);
  const chatId = urlParams.get('id');

  await fetch('/api/enviar-mensaje', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chatId, texto, cifrado: cifradoActivo })
  });

  document.getElementById('mensaje').value = '';
});


//Configuración de Supabase
const supabaseUrl = 'https://ohatguqavmiiytptetmy.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oYXRndXFhdm1paXl0cHRldG15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1NjE0NjcsImV4cCI6MjA2MzEzNzQ2N30.jeBEQmxvW0lBGcaOVlDTXraEHAFMEngyC2vyeLxqwtg';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function enviarArchivo() {
    const archivo = document.getElementById("file-input").files[0];
    if (!archivo) return;

    const nombreArchivo = `${Date.now()}_${archivo.name}`;

    const { data, error } = await supabaseClient.storage
        .from('chat-archivos')
        .upload(nombreArchivo, archivo, {
            cacheControl: '3600',
            upsert: false
        });

    if (error) {
        console.error("❌ Error al subir archivo:", error.message);
        return;
    }

    const { data: publicUrlData } = supabaseClient
        .storage
        .from('chat-archivos')
        .getPublicUrl(nombreArchivo);

    const urlArchivo = publicUrlData.publicUrl;

    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get('id');

    socket.emit("mensaje", {
        tipo: "archivo",
        contenido: urlArchivo,
        chatId: chatId
    });

//Ahora también envía el archivo al servidor para guardarlo
await fetch("/api/enviar-mensaje", {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
    body: JSON.stringify({
        chatId: chatId,
        texto: "", //Mensaje vacío porque es un archivo
        archivoUrl: urlArchivo
    })
});

    console.log("📂 Archivo subido:", urlArchivo);
}

// Muestra mensajes de texto o archivos (imágenes o enlaces)
socket.on("nuevoMensaje", (mensaje) => {
    const mensajesDiv = document.getElementById('mensajes');
    const div = document.createElement('div');
    div.className = 'mb-2';
    
    const sender = mensaje.sender?.nombreUsuario || "Desconocido";
    
    //Mostrar texto del mensaje
    div.innerHTML = `<strong>${sender}:</strong> ${mensaje.texto || ""}`;

    //Manejo de archivos adjuntos
    if (mensaje.archivoUrl) {
        const extension = mensaje.archivoUrl.split('.').pop().toLowerCase();
        if (["jpg", "jpeg", "png", "gif", "webp"].includes(extension)) {
            const imgElemento = document.createElement('img');
            imgElemento.src = mensaje.archivoUrl;
            imgElemento.alt = "Imagen adjunta";
            imgElemento.style = "max-width:200px; border-radius:5px; margin-top:5px;";
            div.appendChild(imgElemento);
        } else {
            div.innerHTML += `<br><a href="${mensaje.archivoUrl}" target="_blank">📂 Ver archivo adjunto</a>`;
        }
    }

    mensajesDiv.appendChild(div);
    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
});
 
//Botón para iniciar videollamada
document.getElementById('startVideoCall').addEventListener('click', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get('id');
    window.location.href = `Videollamada.html?chatId=${chatId}`;
});

</script>

</body>
</html>