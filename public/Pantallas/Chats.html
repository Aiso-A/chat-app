<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ByteTalk - Chat</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Exo+2:wght@800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/Chats.css" />
  <link rel="stylesheet" href="/Sidebar.css" />
</head>
<body>

  <!-- Menú lateral -->
  <aside class="sidebar" aria-label="Menú lateral">
    <h2 class="app-title">ByteTalk</h2>
    <ul>
      <li><a href="/Pantallas/Chats.html">Volver a chats</a></li>
      <li><a href="/Pantallas/Perfil.html">Perfil</a></li>
      <li><a href="/Pantallas/Admin.html">Tareas</a></li>
      <li><a href="/Pantallas/LogIn.html">Cerrar sesión</a></li>
    </ul>
    <p id="username" class="text-light mt-3 ms-3"></p>
  </aside>

  <!-- Contenido de chats -->
  <main class="container mt-4">
    <section>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Chats Individuales</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoChatModal">
          <i class="bi bi-person-plus"></i> Nuevo chat
        </button>
      </div>
      <div id="chats-individuales" class="mb-4"></div>
    </section>

    <section>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Chats Grupales</h3>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevoGrupoModal">
          <i class="bi bi-people-fill"></i> Nuevo grupo
        </button>
      </div>
      <div id="chats-grupales"></div>
    </section>
  </main>

  <!-- Modal Chat Individual -->
  <div class="modal fade" id="nuevoChatModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content modal-style">
        <div class="modal-header">
          <h5 class="modal-title">Crear nuevo chat individual</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="usuariosSelect">Selecciona un usuario:</label>
          <select id="usuariosSelect" class="form-select mt-2 select-style"></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" onclick="crearChatIndividual()">Crear chat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Chat Grupal -->
  <div class="modal fade" id="nuevoGrupoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content modal-style">
        <div class="modal-header">
          <h5 class="modal-title">Crear nuevo grupo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="nombreGrupo">Nombre del grupo:</label>
          <input id="nombreGrupo" type="text" class="form-control mb-3 select-style" placeholder="Ej. Proyecto Final">

          <label for="usuariosGrupo">Selecciona al menos 2 usuarios:</label>
          <select id="usuariosGrupo" class="form-select mt-2 select-style" multiple style="height: 200px;"></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" onclick="crearGrupo()">Crear grupo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- Script de lógica -->
  <script>
    let usuarioActual = null;
    const socket = io();

    fetch('/api/usuario-actual')
      .then(res => res.json())
      .then(data => {
        if (!data || !data._id) {
          console.warn("⚠️ Usuario no autenticado");
          return;
        }

        usuarioActual = data;
        document.getElementById('username').textContent = data.nombreUsuario;
        socket.emit('usuarioConectado', data.nombreUsuario);

        cargarUsuarios();
        cargarChats();
      })
      .catch(err => {
        console.error('Error al obtener el usuario:', err);
      });

    function cargarUsuarios() {
      fetch('../api/usuarios')
        .then(res => res.json())
        .then(usuarios => {
          usuarios.sort((a, b) => a.nombreUsuario.localeCompare(b.nombreUsuario));
          const selectInd = document.getElementById('usuariosSelect');
          const selectGrupo = document.getElementById('usuariosGrupo');
          selectInd.innerHTML = '';
          selectGrupo.innerHTML = '';

          usuarios.forEach(u => {
            if (u._id !== usuarioActual._id) {
              const option = `<option value="${u._id}">${u.nombreUsuario}</option>`;
              selectInd.innerHTML += option;
              selectGrupo.innerHTML += option;
            }
          });
        });
    }

    function crearChatIndividual() {
      const userId = document.getElementById('usuariosSelect').value;
      fetch('/api/chats/individual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receptorId: userId })
      })
        .then(res => res.json())
        .then(data => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('nuevoChatModal'));
          modal.hide();
          window.location.href = `/Pantallas/Chat.html?id=${data.chatId}&tipo=individual`;
        });
    }

    function crearGrupo() {
      const nombre = document.getElementById('nombreGrupo').value.trim();
      const usuariosSelect = document.getElementById('usuariosGrupo');
      let seleccionados = Array.from(usuariosSelect.selectedOptions).map(opt => opt.value);

      if (nombre === '' || seleccionados.length < 2) {
        alert("Debes escribir un nombre y seleccionar al menos 2 usuarios.");
        return;
      }

      if (!seleccionados.includes(usuarioActual._id)) {
        seleccionados.push(usuarioActual._id);
      }

      fetch('/api/chats/grupo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, usuarios: seleccionados })
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById('nombreGrupo').value = '';
          usuariosSelect.selectedIndex = -1;
          const modal = bootstrap.Modal.getInstance(document.getElementById('nuevoGrupoModal'));
          modal.hide();
          window.location.href = `/Pantallas/Chat.html?id=${data.chatId}&tipo=grupo`;
        });
    }

    function cargarChats() {
      fetch('/api/chats')
        .then(res => res.json())
        .then(data => {
          const indiv = document.getElementById('chats-individuales');
          const grup = document.getElementById('chats-grupales');
          indiv.innerHTML = '';
          grup.innerHTML = '';

          if (data.individuales.length === 0) {
            indiv.innerHTML = "<p class='text-muted'>No tienes chats individuales aún.</p>";
          } else {
            data.individuales.forEach(chat => {
              const otro = chat.participantes.find(p => p._id !== usuarioActual._id);
              indiv.innerHTML += `<div class="chat-card" onclick="window.location.href='/Pantallas/Chat.html?id=${chat._id}&tipo=individual'">${otro.nombreUsuario}</div>`;
            });
          }

          if (data.grupales.length === 0) {
            grup.innerHTML = "<p class='text-muted'>No hay grupos creados todavía.</p>";
          } else {
            data.grupales.forEach(chat => {
              grup.innerHTML += `<div class="chat-card" onclick="window.location.href='/Pantallas/Chat.html?id=${chat._id}&tipo=grupo'">${chat.nombre}</div>`;
            });
          }
        });
    }

    socket.on('duplicado', () => {
      alert('⚠️ Has iniciado sesión en otro dispositivo. Esta sesión se cerrará.');
      window.location.href = '/Pantallas/LogIn.html';
    });
  </script>

</body>
</html>
