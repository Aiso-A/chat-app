<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ByteTalk - Chat</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Exo+2:wght@800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="../Chats.css" />
  <link rel="stylesheet" href="../Sidebar.css" />
</head>
<body>

  <!-- Menú lateral -->
  <nav class="sidebar">
    <h2 class="app-title" style="font-family: 'Saira Stencil One', cursive;">ByteTalk</h2>
    <ul>
      <li><a href="/Pantallas/Chats.html">Volver a chats</a></li>
      <li><a href="/Pantallas/Perfil.html">Perfil</a></li>
      <li><a href="/Pantallas/Admin.html">Tareas</a></li>
      <li><a href="/LogIn.html">Cerrar sesión</a></li>
    </ul>
    <p id="username" class="text-light mt-3 ms-3"></p>
  </nav>

  <!-- Contenido de chats -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Chats Individuales</h3>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoChatModal">
        <i class="bi bi-person-plus-fill"></i> Nuevo chat
      </button>
    </div>
    <div id="chats-individuales" class="mb-4"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Chats Grupales</h3>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevoGrupoModal">
        <i class="bi bi-people-fill"></i> Nuevo grupo
      </button>
    </div>
    <div id="chats-grupales"></div>
  </div>

  <!-- Modal Chat Individual -->
  <div class="modal fade" id="nuevoChatModal" tabindex="-1" aria-labelledby="nuevoChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color: #121212; color: white;">
        <div class="modal-header">
          <h5 class="modal-title" id="nuevoChatModalLabel">Crear nuevo chat individual</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="usuariosSelect">Selecciona un usuario:</label>
          <select id="usuariosSelect" class="form-select mt-2" style="background-color: #222; color: white;"></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" onclick="crearChatIndividual()">Crear chat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Chat Grupal -->
  <div class="modal fade" id="nuevoGrupoModal" tabindex="-1" aria-labelledby="nuevoGrupoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color: #121212; color: white;">
        <div class="modal-header">
          <h5 class="modal-title" id="nuevoGrupoModalLabel">Crear nuevo grupo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="nombreGrupo">Nombre del grupo:</label>
          <input id="nombreGrupo" type="text" class="form-control mb-3" placeholder="Ej. Proyecto Final" style="background-color: #222; color: white;">

          <label for="usuariosGrupo">Selecciona al menos 2 usuarios:</label>
          <select id="usuariosGrupo" class="form-select mt-2" multiple style="background-color: #222; color: white; height: 200px;"></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" onclick="crearGrupo()">Crear grupo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- Script de lógica -->
  <script>
    let usuarioActual = null;
    const socket = io();

    // Obtener usuario actual una sola vez
    fetch('/api/usuario-actual')
      .then(res => res.json())
      .then(data => {
        if (!data || !data._id) {
          console.warn("⚠️ Usuario no autenticado");
          window.location.href = "LogIn.html";
          return;
        }

        usuarioActual = data;
        document.getElementById('username').textContent = data.nombreUsuario;
        socket.emit('usuarioConectado', data.nombreUsuario);

        cargarUsuarios();
        cargarChats();
      })
      .catch(err => {
        console.error('Error al obtener el usuario:', err);
        window.location.href = "LogIn.html";
      });

   // Cargar usuarios para modales
function cargarUsuarios() {
  fetch('/api/usuarios')
    .then(res => res.json())
    .then(usuarios => {
      const selectInd = document.getElementById('usuariosSelect');
      const selectGrupo = document.getElementById('usuariosGrupo');
      selectInd.innerHTML = '';
      selectGrupo.innerHTML = '';

      usuarios.forEach(u => {
        if (u._id !== usuarioActual._id) {
          //chat individual
          let opt1 = document.createElement('option');
          opt1.value = u._id;
          opt1.textContent = u.nombreUsuario;
          selectInd.appendChild(opt1);

          //chat grupal
          let opt2 = document.createElement('option');
          opt2.value = u._id;
          opt2.textContent = u.nombreUsuario;
          selectGrupo.appendChild(opt2);
        }
      });
    })
    .catch(err => console.error('Error al cargar usuarios:', err));
}

// Crear chat individual
function crearChatIndividual() {
  const userId = document.getElementById('usuariosSelect').value;
  fetch('/api/chats/individual', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ receptorId: userId })
  })
    .then(res => res.json())
    .then(data => {
      const nuevoChatModal = bootstrap.Modal.getInstance(document.getElementById('nuevoChatModal'));
      nuevoChatModal.hide();
      
      window.location.href = `/Pantallas/Chat.html?id=${data.chatId}&tipo=individual`;
    })
    .catch(err => alert('Error al crear chat individual: ' + err));
}

// Crear grupo
function crearGrupo() {
  const nombre = document.getElementById('nombreGrupo').value.trim();
  const usuariosSelect = document.getElementById('usuariosGrupo');
  let seleccionados = Array.from(usuariosSelect.selectedOptions).map(opt => opt.value);

  if (nombre === '' || seleccionados.length < 2) {
    alert("Debes escribir un nombre y seleccionar al menos 2 usuarios.");
    return;
  }

if (!seleccionados.includes(usuarioActual._id.toString())) {
  seleccionados.push(usuarioActual._id.toString());
}

  fetch('/api/chats/grupo', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nombre, usuarios: seleccionados })
  })
    .then(res => res.json())
    .then(data => {
      const nuevoGrupoModal = bootstrap.Modal.getInstance(document.getElementById('nuevoGrupoModal'));
      nuevoGrupoModal.hide();
      document.getElementById('nombreGrupo').value = '';
      usuariosSelect.selectedIndex = -1;

      window.location.href = `/Pantallas/Chat.html?id=${data.chatId}&tipo=grupo`;
    })
    .catch(err => alert('Error al crear grupo: ' + err));
}

    // Cargar chats
    function cargarChats() {
      fetch('/api/chats')
        .then(res => res.json())
        .then(data => {
          const individualesDiv = document.getElementById('chats-individuales');
          const grupalesDiv = document.getElementById('chats-grupales');

          individualesDiv.innerHTML = '';
          grupalesDiv.innerHTML = '';

          // Mensaje si no hay chats individuales
          if (!data.individuales || data.individuales.length === 0) {
            individualesDiv.innerHTML = '<p class="text-muted fst-italic">No tienes chats individuales.</p>';
          } else {
            data.individuales.forEach(chat => {
              const a = document.createElement('a');
              a.href = `Chat.html?id=${chat._id}&tipo=individual`;
              a.classList.add('chat-card');
              a.setAttribute('tabindex', '0');
              a.textContent = chat.nombre || "Chat individual";
              individualesDiv.appendChild(a);
            });
          }

          // Mensaje si no hay chats grupales
          if (!data.grupales || data.grupales.length === 0) {
            grupalesDiv.innerHTML = '<p class="text-muted fst-italic">No tienes chats grupales.</p>';
          } else {
            data.grupales.forEach(chat => {
              const a = document.createElement('a');
              a.href = `Chat.html?id=${chat._id}&tipo=grupo`;
              a.classList.add('chat-card');
              a.setAttribute('tabindex', '0');
              a.textContent = chat.nombre || "Chat grupal";
              grupalesDiv.appendChild(a);
            });
          }
        })
        .catch(err => {
          console.error('Error al cargar chats:', err);
          document.getElementById('chats-individuales').innerHTML = '<p class="text-danger">Error cargando chats individuales.</p>';
          document.getElementById('chats-grupales').innerHTML = '<p class="text-danger">Error cargando chats grupales.</p>';
        });
    }

    // Socket.io: escuchar cambios en chats y recargar
    socket.on('nuevoChat', () => cargarChats());
    socket.on('chatActualizado', () => cargarChats());
  </script>
</body>
</html>
