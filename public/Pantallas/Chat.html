<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ByteTalk - ConversaciÃ³n</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Exo+2:wght@800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/Chats.css" />
<link rel="stylesheet" href="/Sidebar.css" />
<style>
    .chat-container {
      max-width: 800px;
      margin: 2rem auto; 
      padding: 0 1rem;
    }
</style>
</head>
<body>
 
  <!-- Sidebar -->
<nav class="sidebar">
<h2 class="app-title">ByteTalk</h2>
<ul>
<li><a href="/Pantallas/Chats.html">Volver a chats</a></li>
<li><a href="/Pantallas/Perfil.html">Perfil</a></li>
<li><a href="/Pantallas/Admin.html">Tareas</a></li>
<li><a href="/LogIn.html">Cerrar sesiÃ³n</a></li>
</ul>
<p id="username" class="text-light mt-3 ms-3"></p>
</nav>
 
  <!-- Contenedor del chat -->
<div class="chat-container">
<div class="card">
<div class="card-header d-flex align-items-center justify-content-between">
  <div id="chat-header" class="d-flex align-items-center"></div>
  <div>
    <button id="startVideoCall" class="btn btn-outline-primary" style="margin-right:10px;">ðŸ“¹ Videollamada</button>
    <button id="toggleEncryption" class="btn btn-outline-secondary">ðŸ”’ Cifrado: Desactivado</button>
  </div>
</div>
<div class="card-body" id="mensajes" style="height: 400px; overflow-y: auto;"></div>
<div class="card-footer">
<form id="formularioMensaje" class="d-flex gap-2">
<input type="text" id="mensaje" class="form-control" placeholder="Escribe tu mensaje..." required />
<input type="file" id="archivo" class="form-control"> <!-- ðŸ”¹ Nuevo: Enviar archivos -->
<button type="submit" class="btn btn-primary">Enviar</button>
</form>
</div>
</div>
</div>
 
<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>
<script>
    let usuarioActual = null;
    const socket = io();

    // Obtener usuario actual
    fetch('/api/usuario-actual')
      .then(res => res.json())
      .then(data => {
        if (!data || !data._id) {
          console.warn("âš ï¸ Usuario no autenticado");
          window.location.href = "LogIn.html";
          return;
        }
        usuarioActual = data;
        document.getElementById('username').textContent = data.nombreUsuario;
        socket.emit('usuarioConectado', data.nombreUsuario);
        iniciarChat();
      })
      .catch(err => {
        console.error("Error al obtener usuario:", err);
        window.location.href = '/LogIn.html';
      });

    function iniciarChat() {
      const urlParams = new URLSearchParams(window.location.search);
      const chatId = urlParams.get('id');
      const tipo = urlParams.get('tipo');
      console.log("ðŸ” ParÃ¡metros de URL:", Object.fromEntries(urlParams));
      socket.emit('joinRoom', chatId);
      loadChatInfo(chatId, tipo);
      loadMensajes(chatId);
    }

    function loadMensajes(chatId) {
      fetch(`/api/mensajes?chatId=${chatId}`)
        .then(res => res.json())
        .then(mensajes => {
          console.log("ðŸ“© Mensajes recibidos:", mensajes);
          const mensajesDiv = document.getElementById('mensajes');
          mensajesDiv.innerHTML = '';
          mensajes.forEach(m => {
            const div = document.createElement('div');
            div.className = 'mb-2';
            div.innerHTML = `<strong>${m.sender.nombreUsuario}:</strong> ${m.texto || ''}`;

            // ðŸ”¹ Mostrar archivos adjuntos
            if (m.fileUrl) {
              if (m.fileType.startsWith("image")) {
                div.innerHTML += `<br><img src="${m.fileUrl}" alt="Imagen" style="max-width:200px;border-radius:8px;">`;
              } else {
                div.innerHTML += `<br><a href="${m.fileUrl}" download>ðŸ“„ Descargar archivo</a>`;
              }
            }

            mensajesDiv.appendChild(div);
          });
          mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
        })
        .catch(err => console.error('Error al cargar mensajes:', err));
    }

    // ðŸ”’ Cifrado opcional
    let cifradoActivo = false;
    document.getElementById('toggleEncryption').addEventListener('click', () => {
      cifradoActivo = !cifradoActivo;
      document.getElementById('toggleEncryption').textContent = cifradoActivo ? "ðŸ”“ Cifrado: Activado" : "ðŸ”’ Cifrado: Desactivado";
    });

    // ðŸ“© EnvÃ­o de mensajes y archivos
    document.getElementById('formularioMensaje').addEventListener('submit', async (e) => {
      e.preventDefault();
      const texto = document.getElementById('mensaje').value.trim();
      const archivo = document.getElementById('archivo').files[0];
      const chatId = new URLSearchParams(window.location.search).get('id');

      const formData = new FormData();
      formData.append("chatId", chatId);
      formData.append("texto", texto);
      formData.append("cifrado", cifradoActivo);
      if (archivo) formData.append("file", archivo);

      await fetch('/api/enviar-mensaje', {
        method: 'POST',
        body: formData
      });

      document.getElementById('mensaje').value = '';
      document.getElementById('archivo').value = '';
    });

    socket.on('nuevoMensaje', (mensaje) => {
      const mensajesDiv = document.getElementById('mensajes');
      const div = document.createElement('div');
      div.className = 'mb-2';
      div.innerHTML = `<strong>${mensaje.sender.nombreUsuario}:</strong> ${mensaje.texto || ''}`;

      if (mensaje.fileUrl) {
        if (mensaje.fileType.startsWith("image")) {
          div.innerHTML += `<br><img src="${mensaje.fileUrl}" alt="Imagen" style="max-width:200px;border-radius:8px;">`;
        } else {
          div.innerHTML += `<br><a href="${mensaje.fileUrl}" download>ðŸ“„ Descargar archivo</a>`;
        }
      }

      mensajesDiv.appendChild(div);
      mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
    });
</script>

</body>
</html>

 