<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ByteTalk - Llamando..</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Exo+2:wght@800&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/Videollamada.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">       
</head>
<body>
    
    <div class="video-call-container">
        <!-- Usuario -->
        <div class="video-container">
            <video id="local-video" autoplay muted></video>
        </div>

        <!-- Contacto -->
        <div class="video-container">
            <video id="remote-video" autoplay></video>
        </div>
    </div>

    <!-- Controles -->
    <div class="call-controls">
        <button id="mute-btn" class="control-btn">
            <i class="bx bxs-microphone"></i>
        </button>
        <button id="camera-btn" class="control-btn">
            <i class="bx bxs-video"></i>
        </button>
        <a href="/Pantallas/Chat.html" id="end-call-btn" class="control-btn end-call">
            <i class="bx bxs-phone-off"></i>
        </a>
    </div>

    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let localStream, peerConnection;
        const socket = io();

        // Obtener el chatId de la URL para usarlo como identificador de la sala
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('chatId');

        // Capturar la cámara y el micrófono
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;
                inicializarPeerConnection();
                socket.emit('joinRoom', roomId);
            })
            .catch(error => console.error("Error accediendo a la cámara/micrófono:", error));

        function inicializarPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            // Agregar tracks del usuario a la conexión
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Recibir y mostrar el stream remoto
            peerConnection.ontrack = event => {
                document.getElementById('remote-video').srcObject = event.streams[0];
                console.log("Recibiendo stream remoto.");
            };

            // Manejar candidatos ICE
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('iceCandidate', { candidate: event.candidate, roomId });
                }
            };
        }

        // Manejadores de eventos con Socket.io
        socket.on('initiateCall', () => {
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.emit('offer', { roomId, sdp: peerConnection.localDescription });
                });
        });

        socket.on('offer', (data) => {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    socket.emit('answer', { roomId, sdp: peerConnection.localDescription });
                });
        });

        socket.on('answer', (data) => {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
        });

        socket.on('iceCandidate', (data) => {
            if (data.candidate) {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });

        // Micrófono Toggle
        document.getElementById("mute-btn").addEventListener("click", function () {
            let icon = this.querySelector("i");
            let audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            icon.classList.toggle("bxs-microphone-off");
        });

        // Cámara Toggle
        document.getElementById("camera-btn").addEventListener("click", function () {
            let icon = this.querySelector("i");
            let videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            icon.classList.toggle("bxs-video-off");
        });

        // Cierre de conexión al salir de la página
        window.onunload = window.onbeforeunload = () => {
            if (peerConnection) peerConnection.close();
            socket.disconnect();
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
