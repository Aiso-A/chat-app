<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ByteTalk - Perfil</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Exo+2:wght@800&family=Saira+Stencil+One&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="/Perfil.css">
        <link rel="stylesheet" href="/Sidebar.css">
        <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">       
    </head>
<body>

     <!-- Men√∫ lateral -->
    <nav class="sidebar d-flex flex-column p-3">
        <h2 class="app-title text-center">ByteTalk</h2>
        <ul class="nav flex-column">
            <li class="nav-item"><a href="/Pantallas/Chats.html" class="nav-link">Volver a Chats</a></li>
            <li class="nav-item"><a href="/Pantallas/Perfil.html" class="nav-link">Perfil</a></li>
            <li class="nav-item"><a href="/Pantallas/Admin.html" class="nav-link">Tareas</a></li>
            <li class="nav-item"><a href="/LogIn.html" class="nav-link">Cerrar sesi√≥n</a></li>
        </ul>
    </nav>

    <div class="container profile-container">
        
        <!-- Secci√≥n de Perfil -->
        <div class="profile-header text-center">
            <div class="profile-avatar"></div> 
            <h2 class="username">Cargando...</h2> 
            <p class="full-name">Cargando...</p> 
            <p class="email">Cargando...</p> 
            <span class="status online">‚óè Activo</span>
        </div>

        <!-- Secci√≥n de Recompensas -->
        <div class="rewards-section">
            <h3 class="section-title">üéâ Recompensas</h3>
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar">0%</div> <!-- Barra de progreso -->
                </div>
                <p class="progress-text">Cargando...</p>
            </div>

            <div class="reward">
                <div class="reward-image"></div>
                <p class="reward-description">Avatar exclusivo desbloqueado</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
           const socket = io();

    socket.on('tareaCompletada', (data) => {
        console.log("‚úÖ Tarea completada:", data);
        cargarPerfil(); // Recargar perfil para actualizar recompensas
    });

        async function cargarPerfil() {
            try {
                let response = await fetch('/api/usuario-actual');
                let usuario = await response.json();

                // Actualizar datos del usuario en la interfaz
                document.querySelector('.username').textContent = usuario.nombreUsuario;
                document.querySelector('.full-name').textContent = usuario.nombreCompleto;
                document.querySelector('.email').textContent = usuario.email;
                document.querySelector('.profile-avatar').style.backgroundImage = `url(${usuario.avatar})`;

                let progreso = (usuario.tareasCompletadas % 5) * 20;
                let tareasRestantes = 5 - (usuario.tareasCompletadas % 5);

                document.querySelector('.progress-bar').style.width = `${progreso}%`;
                document.querySelector('.progress-bar').textContent = `${progreso}%`;
                document.querySelector('.progress-text').textContent = `¬°Te faltan ${tareasRestantes} tareas para desbloquear la siguiente recompensa!`;

                // Mostrar la imagen del pr√≥ximo avatar a desbloquear
                let siguienteAvatar = usuario.nivelRecompensa + 1;
                if (siguienteAvatar <= 5) {
                    document.querySelector('.reward-image').style.backgroundImage = `url(/img/avatar${siguienteAvatar}.png)`;
                } else {
                    document.querySelector('.reward-description').textContent = "¬°Has desbloqueado todas las recompensas!";
                }

                // Verificar si se debe cambiar el avatar por una recompensa
                verificarRecompensa(usuario._id);
                
            } catch (error) {
                console.error("Error al cargar perfil:", error);
            }
        }

        async function verificarRecompensa(userId) {
            try {
                let response = await fetch(`/api/usuario/revisar-recompensa/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                let data = await response.json();
                if (data.avatar) {
                    document.querySelector('.profile-avatar').style.backgroundImage = `url(${data.avatar})`;
                }
            } catch (error) {
                console.error("Error al verificar recompensa:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", cargarPerfil);
    </script>
</body>
</html>
